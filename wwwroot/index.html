<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Review Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input, select {
            flex: 1;
            min-width: 150px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .pr-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #0078d4;
        }

        .pr-item:hover {
            background: #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pr-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .pr-item-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .pr-item-id {
            color: #0078d4;
            font-weight: 600;
            font-size: 12px;
        }

        .pr-item-meta {
            font-size: 12px;
            color: #666;
        }

        button {
            padding: 10px 20px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        button:hover {
            background: #005a9e;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pr-info {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .pr-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .pr-meta {
            color: #666;
            font-size: 14px;
        }

        .files-container {
            display: grid;
            gap: 20px;
        }

        .file-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .file-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-path {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #2c3e50;
        }

        .change-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .change-type.add {
            background: #d4edda;
            color: #155724;
        }

        .change-type.edit {
            background: #fff3cd;
            color: #856404;
        }

        .change-type.delete {
            background: #f8d7da;
            color: #721c24;
        }

        .diff-container {
            padding: 0;
            overflow-x: auto;
            background: #f6f8fa;
        }

        .diff-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .diff-table td {
            padding: 2px 10px;
            vertical-align: top;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .diff-line-number {
            width: 40px;
            text-align: right;
            color: #6e7781;
            background: #f6f8fa;
            border-right: 1px solid #d0d7de;
            user-select: none;
            padding-right: 10px;
        }

        .diff-line-content {
            padding-left: 15px;
        }

        .diff-line.added {
            background: #ccffd8;
        }

        .diff-line.added .diff-line-number {
            background: #ccffd8;
        }

        .diff-line.added .diff-line-content::before {
            content: '+';
            color: #1a7f37;
            margin-right: 10px;
        }

        .diff-line.removed {
            background: #ffd7d5;
        }

        .diff-line.removed .diff-line-number {
            background: #ffd7d5;
        }

        .diff-line.removed .diff-line-content::before {
            content: '-';
            color: #d1242f;
            margin-right: 10px;
        }

        .diff-line.context {
            background: #ffffff;
        }

        .diff-line.context .diff-line-content::before {
            content: ' ';
            margin-right: 10px;
        }

        /* Side-by-side diff styles - GitHub style split view */
        .diff-split-view {
            display: -ms-grid;
            display: grid;
            -ms-grid-columns: 1fr 1fr;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            border: 1px solid #d0d7de;
            width: 100%;
        }

        /* Edge fallback using flexbox */
        @supports not (display: grid) {
            .diff-split-view {
                display: -ms-flexbox;
                display: flex;
                -ms-flex-direction: row;
                flex-direction: row;
            }
            .diff-split-pane {
                -ms-flex: 1;
                flex: 1;
                width: 50%;
            }
        }

        .diff-split-pane {
            overflow-x: auto;
            border-right: 1px solid #d0d7de;
            min-width: 0; /* Fix for Edge grid overflow */
        }

        .diff-split-pane:last-child {
            border-right: none;
        }

        .diff-split-pane:nth-child(1) {
            -ms-grid-column: 1;
        }

        .diff-split-pane:nth-child(2) {
            -ms-grid-column: 2;
        }

        .diff-split-header {
            background: #f6f8fa;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 12px;
            border-bottom: 1px solid #d0d7de;
            color: #57606a;
        }

        .diff-table.split {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            table-layout: fixed; /* Fix for Edge table rendering */
        }

        .diff-table.split td {
            padding: 2px 10px;
            vertical-align: top;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word; /* Edge compatibility */
        }

        .diff-table.split .diff-line-number {
            width: 40px;
            text-align: right;
            color: #6e7781;
            background: #f6f8fa;
            border-right: 1px solid #d0d7de;
            user-select: none;
            padding-right: 10px;
        }

        .diff-table.split .diff-line-content {
            padding-left: 15px;
        }

        .diff-table.split .diff-line.removed {
            background: #ffebe9;
        }

        .diff-table.split .diff-line.removed .diff-line-number {
            background: #ffebe9;
        }

        .diff-table.split .diff-line.added {
            background: #dafbe1;
        }

        .diff-table.split .diff-line.added .diff-line-number {
            background: #dafbe1;
        }

        .diff-table.split .diff-line.context {
            background: #ffffff;
        }

        .diff-table.split .diff-line.empty {
            background: #f6f8fa;
        }

        .diff-table.split .diff-line.empty .diff-line-number {
            background: #f6f8fa;
        }

        .diff-header {
            background: #f6f8fa;
            padding: 10px 15px;
            border-bottom: 1px solid #d0d7de;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #57606a;
            font-weight: 600;
        }

        .comments-section {
            border-top: 1px solid #e9ecef;
            padding: 20px;
            background: #f8f9fa;
        }

        .comment-header {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .comment-item {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .comment-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.severity-high {
            background: #dc3545;
            color: white;
        }

        .badge.severity-medium {
            background: #ffc107;
            color: #333;
        }

        .badge.severity-low {
            background: #17a2b8;
            color: white;
        }

        .badge.type {
            background: #6c757d;
            color: white;
        }

        .comment-text {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-post {
            background: #28a745;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-post:hover {
            background: #218838;
        }

        .btn-posted {
            background: #6c757d;
            cursor: default;
        }

        .btn-posted:hover {
            background: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .line-number {
            color: #0078d4;
            font-weight: 600;
        }

        .summary {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #0078d4;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Login/Configuration Page -->
    <div id="loginContainer" class="container" style="display:none;">
        <div style="max-width: 500px; margin: 100px auto; background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h1 style="text-align: center; margin-bottom: 30px;">ðŸ¤– Code Review Agent</h1>
            <h2 style="font-size: 18px; margin-bottom: 20px; color: #666;">Configure Azure DevOps Access</h2>

            <div id="loginError" class="error" style="display: none; margin-bottom: 20px;"></div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Organization Name:</label>
                <input type="text" id="organizationInput" value="Skype" placeholder="e.g., SCC or mycompany"
                       style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">Your Azure DevOps organization name from the URL (dev.azure.com/<strong>organization</strong>)</p>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Personal Access Token:</label>
                <input type="password" id="patInput" placeholder="Enter your Azure DevOps PAT"
                       style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    Required scopes: <strong>Code (Read)</strong><br>
                    <a href="https://dev.azure.com/_usersSettings/tokens" target="_blank" style="color: #0078d4;">Create a new PAT</a>
                </p>
            </div>

            <button id="loginBtn" onclick="validateAndLogin()" style="width: 100%; padding: 12px; font-size: 16px;">
                Continue
            </button>

            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
                <strong>Note:</strong> Your credentials are validated against Azure DevOps and stored only in your browser session. They are never saved to disk.
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainContainer" class="container" style="display:none;">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>ðŸ¤– AI Code Review Agent</h1>
                <button onclick="logout()" style="background: #6c757d; padding: 8px 16px; font-size: 13px;">
                    Logout
                </button>
            </div>
            <div style="margin: 10px 0; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 13px;">
                <strong>Organization:</strong> <span id="currentOrg"></span>
            </div>
            <div class="input-group">
                <select id="project" onchange="onProjectChange()">
                    <option value="">Select Project...</option>
                </select>
                <select id="repository" onchange="onRepositoryChange()">
                    <option value="">Select Repository...</option>
                </select>
                <button id="loadPRsBtn" onclick="loadActivePRs()" style="display:none;">Load Active PRs</button>
            </div>
        </header>

        <div id="prListContainer" style="display:none; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h2 style="margin-bottom: 15px;">Active Pull Requests</h2>
            <div id="prList"></div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing pull request... This may take a minute.</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div id="reviewContainer" style="display: none;">
            <div class="pr-info">
                <div class="pr-title" id="prTitle"></div>
                <div class="pr-meta" id="prMeta"></div>
            </div>

            <div class="summary">
                <h2>Review Summary</h2>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="filesCount">0</div>
                        <div class="stat-label">Files Changed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="commentsCount">0</div>
                        <div class="stat-label">Total Comments</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="highCount">0</div>
                        <div class="stat-label">High Severity</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mediumCount">0</div>
                        <div class="stat-label">Medium Severity</div>
                    </div>
                </div>
            </div>

            <div id="filesContainer" class="files-container"></div>
        </div>
    </div>

    <script>
        let currentReview = null;
        let selectedProject = '';
        let selectedRepository = '';

        // Check configuration status on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await checkConfigStatus();
        });

        async function checkConfigStatus() {
            try {
                const response = await fetch('/api/CodeReview/config/status');
                const status = await response.json();

                // Populate form with defaults
                if (status.defaultPat) {
                    document.getElementById('patInput').value = status.defaultPat;
                }
                
                if (status.organization) {
                    document.getElementById('organizationInput').value = status.organization;
                }

                // Show login page - don't auto-login to avoid proxy timing issues
                // User needs to manually click the button
                document.getElementById('loginContainer').style.display = 'block';
                
                // If already configured, show a different message
                if (status.isConfigured && status.defaultPat && status.organization) {
                    document.getElementById('loginBtn').textContent = 'Continue with Saved Credentials';
                    console.log('Credentials loaded from .env file. Click "Continue" to proceed.');
                }
                
            } catch (error) {
                console.error('Error checking config status:', error);
                // Show login page on error
                document.getElementById('loginContainer').style.display = 'block';
            }
        }

        async function validateAndLogin() {
            const organization = document.getElementById('organizationInput').value.trim();
            const pat = document.getElementById('patInput').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            // Validate inputs
            if (!organization || !pat) {
                showLoginError('Please fill in both organization and Personal Access Token');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Validating...';
            loginError.style.display = 'none';

            try {
                const response = await fetch('/api/CodeReview/config/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        organization: organization,
                        personalAccessToken: pat
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Success - switch to main app
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    document.getElementById('currentOrg').textContent = organization;
                    await loadProjects();
                } else {
                    showLoginError(result.error || 'Failed to validate credentials');
                }
            } catch (error) {
                showLoginError('Network error: ' + error.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Continue';
            }
        }

        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        async function logout() {
            try {
                await fetch('/api/CodeReview/config/clear', { method: 'POST' });
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('organizationInput').value = 'Skype';
                document.getElementById('patInput').value = '';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/CodeReview/projects');
                const projects = await response.json();

                const projectSelect = document.getElementById('project');
                projectSelect.innerHTML = '<option value="">Select Project...</option>';

                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.name;
                    option.textContent = project.displayName;
                    projectSelect.appendChild(option);
                });
            } catch (error) {
                showError('Failed to load projects: ' + error.message);
            }
        }

        async function onProjectChange() {
            const projectSelect = document.getElementById('project');
            selectedProject = projectSelect.value;

            // Clear repository and PR list
            document.getElementById('repository').innerHTML = '<option value="">Select Repository...</option>';
            document.getElementById('prListContainer').style.display = 'none';
            document.getElementById('loadPRsBtn').style.display = 'none';

            if (!selectedProject) return;

            try {
                const response = await fetch(`/api/CodeReview/repositories/${selectedProject}`);
                const repositories = await response.json();

                const repoSelect = document.getElementById('repository');
                repoSelect.innerHTML = '<option value="">Select Repository...</option>';

                repositories.forEach(repo => {
                    const option = document.createElement('option');
                    option.value = repo;
                    option.textContent = repo;
                    repoSelect.appendChild(option);
                });
            } catch (error) {
                showError('Failed to load repositories: ' + error.message);
            }
        }

        async function onRepositoryChange() {
            const repoSelect = document.getElementById('repository');
            selectedRepository = repoSelect.value;

            if (selectedRepository) {
                document.getElementById('loadPRsBtn').style.display = 'inline-block';
                await loadActivePRs();
            } else {
                document.getElementById('loadPRsBtn').style.display = 'none';
                document.getElementById('prListContainer').style.display = 'none';
            }
        }

        async function loadActivePRs() {
            if (!selectedProject || !selectedRepository) {
                showError('Please select a project and repository');
                return;
            }

            try {
                document.getElementById('loading').style.display = 'block';
                hideError();
                const response = await fetch(`/api/CodeReview/pullrequests/${selectedProject}/${selectedRepository}`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));

                    if (response.status === 401 || errorData.requiresConfig) {
                        // Token expired or invalid - redirect to login
                        showError(errorData.error || 'Your session has expired. Please log in again.');
                        setTimeout(() => logout(), 2000);
                        return;
                    } else if (response.status === 404) {
                        throw new Error(errorData.error || 'Project or repository not found. Please check the names.');
                    } else {
                        throw new Error(errorData.error || 'Failed to load pull requests');
                    }
                }

                const data = await response.json();
                const prs = data.pullRequests || [];

                const prList = document.getElementById('prList');
                prList.innerHTML = '';

                if (prs.length === 0) {
                    prList.innerHTML = '<p style="color: #666;">No active pull requests found in this repository.</p>';
                } else {
                    prs.forEach(pr => {
                        const prItem = createPRItem(pr);
                        prList.appendChild(prItem);
                    });
                }

                document.getElementById('prListContainer').style.display = 'block';
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function createPRItem(pr) {
            const div = document.createElement('div');
            div.className = 'pr-item';
            div.onclick = () => startReviewForPR(pr.id);

            div.innerHTML = `
                <div class="pr-item-header">
                    <div class="pr-item-title">${escapeHtml(pr.title)}</div>
                    <div class="pr-item-id">#${pr.id}</div>
                </div>
                <div class="pr-item-meta">
                    <strong>Author:</strong> ${escapeHtml(pr.createdBy.displayName)} |
                    <strong>Created:</strong> ${new Date(pr.creationDate).toLocaleDateString()}
                </div>
            `;

            return div;
        }

        async function startReviewForPR(prId) {
            await startReview(selectedProject, selectedRepository, prId);
        }

        async function startReview(project, repository, prId) {
            // Use the passed parameters directly (from dropdown selections)
            if (!project || !repository || !prId) {
                showError('Please select a project, repository, and PR');
                return;
            }

            hideError();
            hideSuccess();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('reviewContainer').style.display = 'none';
            document.getElementById('prListContainer').style.display = 'none';

            try {
                const response = await fetch('/api/CodeReview/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project,
                        repository,
                        pullRequestId: parseInt(prId)
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start review');
                }

                currentReview = await response.json();
                displayReview(currentReview);
            } catch (error) {
                showError(error.message);
                document.getElementById('prListContainer').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayReview(review) {
            document.getElementById('reviewContainer').style.display = 'block';

            // Display PR info
            document.getElementById('prTitle').textContent = review.pullRequest.title;
            document.getElementById('prMeta').innerHTML = `
                <strong>Author:</strong> ${review.pullRequest.createdBy.displayName} |
                <strong>Created:</strong> ${new Date(review.pullRequest.creationDate).toLocaleString()} |
                <strong>Source:</strong> ${review.pullRequest.sourceBranch} â†’ ${review.pullRequest.targetBranch}
            `;

            // Display summary
            document.getElementById('filesCount').textContent = review.files.length;
            document.getElementById('commentsCount').textContent = review.comments.length;
            document.getElementById('highCount').textContent =
                review.comments.filter(c => c.severity === 'high').length;
            document.getElementById('mediumCount').textContent =
                review.comments.filter(c => c.severity === 'medium').length;

            // Display files and comments
            const filesContainer = document.getElementById('filesContainer');
            filesContainer.innerHTML = '';

            review.files.forEach((file, index) => {
                const fileComments = review.comments.filter(c => c.filePath === file.path);
                const fileCard = createFileCard(file, fileComments, index);
                filesContainer.appendChild(fileCard);
            });
        }

        function createFileCard(file, comments, index) {
            const card = document.createElement('div');
            card.className = 'file-card';

            const changeTypeClass = file.changeType === 'add' ? 'add' :
                                   file.changeType === 'delete' ? 'delete' : 'edit';

            const diffId = `diff-${index}`;

            card.innerHTML = `
                <div class="file-header">
                    <div class="file-path">${file.path}</div>
                    <div class="change-type ${changeTypeClass}">${file.changeType}</div>
                </div>
                <div class="diff-container" id="${diffId}"></div>
                ${comments.length > 0 ? `
                    <div class="comments-section">
                        <div class="comment-header">
                            ðŸ’¬ ${comments.length} Review Comment${comments.length > 1 ? 's' : ''}
                        </div>
                        ${comments.map(c => createCommentHtml(c)).join('')}
                    </div>
                ` : ''}
            `;

            // Display diff
            setTimeout(() => {
                const diffContainer = document.getElementById(diffId);
                displayDiff(diffContainer, file);
            }, 0);

            return card;
        }

        function displayDiff(container, file) {
            console.log('displayDiff called for:', file.path);
            console.log('content exists:', !!file.content);
            console.log('previousContent exists:', !!file.previousContent);

            const header = document.createElement('div');
            header.className = 'diff-header';
            header.textContent = `@@ ${file.path} @@`;
            container.appendChild(header);

            // Display full file side-by-side comparison
            if (file.previousContent || file.content) {
                console.log('Displaying full file side-by-side for:', file.path);
                displayFullFileSideBySide(container, file);
            } else if (file.unifiedDiff && file.unifiedDiff.trim().length > 0) {
                console.log('Displaying unified diff for:', file.path);
                displayUnifiedDiff(container, file.unifiedDiff);
            } else {
                console.log('Displaying simple diff for:', file.path);
                // Fallback to simple display
                displaySimpleDiff(container, file);
            }
        }

        function displayFullFileSideBySide(container, file) {
            // Create split view container
            const splitView = document.createElement('div');
            splitView.className = 'diff-split-view';

            // Create left pane (old content)
            const leftPane = document.createElement('div');
            leftPane.className = 'diff-split-pane';
            leftPane.innerHTML = '<div class="diff-split-header">Original</div>';
            const leftTable = document.createElement('table');
            leftTable.className = 'diff-table split';
            leftPane.appendChild(leftTable);

            // Create right pane (new content)
            const rightPane = document.createElement('div');
            rightPane.className = 'diff-split-pane';
            rightPane.innerHTML = '<div class="diff-split-header">Changed</div>';
            const rightTable = document.createElement('table');
            rightTable.className = 'diff-table split';
            rightPane.appendChild(rightTable);

            splitView.appendChild(leftPane);
            splitView.appendChild(rightPane);
            container.appendChild(splitView);

            const oldLines = (file.previousContent || '').split('\n');
            const newLines = (file.content || '').split('\n');

            // Compute diff using LCS algorithm
            const diff = computeDiff(oldLines, newLines);

            let leftLineNum = 1;
            let rightLineNum = 1;

            // Render diff operations
            for (const op of diff) {
                if (op.type === 'equal') {
                    // Unchanged line - show on both sides
                    const leftRow = leftTable.insertRow();
                    leftRow.className = 'diff-line context';
                    const leftNumCell = leftRow.insertCell();
                    leftNumCell.className = 'diff-line-number';
                    leftNumCell.textContent = leftLineNum;
                    const leftContentCell = leftRow.insertCell();
                    leftContentCell.className = 'diff-line-content';
                    leftContentCell.textContent = op.line;

                    const rightRow = rightTable.insertRow();
                    rightRow.className = 'diff-line context';
                    const rightNumCell = rightRow.insertCell();
                    rightNumCell.className = 'diff-line-number';
                    rightNumCell.textContent = rightLineNum;
                    const rightContentCell = rightRow.insertCell();
                    rightContentCell.className = 'diff-line-content';
                    rightContentCell.textContent = op.line;

                    leftLineNum++;
                    rightLineNum++;
                } else if (op.type === 'delete') {
                    // Deleted line - show only on left with empty row on right
                    const leftRow = leftTable.insertRow();
                    leftRow.className = 'diff-line removed';
                    const leftNumCell = leftRow.insertCell();
                    leftNumCell.className = 'diff-line-number';
                    leftNumCell.textContent = leftLineNum;
                    const leftContentCell = leftRow.insertCell();
                    leftContentCell.className = 'diff-line-content';
                    leftContentCell.textContent = op.line;

                    const rightRow = rightTable.insertRow();
                    rightRow.className = 'diff-line empty';
                    const rightNumCell = rightRow.insertCell();
                    rightNumCell.className = 'diff-line-number';
                    rightNumCell.textContent = '';
                    const rightContentCell = rightRow.insertCell();
                    rightContentCell.className = 'diff-line-content';
                    rightContentCell.textContent = '';

                    leftLineNum++;
                } else if (op.type === 'insert') {
                    // Added line - show only on right with empty row on left
                    const leftRow = leftTable.insertRow();
                    leftRow.className = 'diff-line empty';
                    const leftNumCell = leftRow.insertCell();
                    leftNumCell.className = 'diff-line-number';
                    leftNumCell.textContent = '';
                    const leftContentCell = leftRow.insertCell();
                    leftContentCell.className = 'diff-line-content';
                    leftContentCell.textContent = '';

                    const rightRow = rightTable.insertRow();
                    rightRow.className = 'diff-line added';
                    const rightNumCell = rightRow.insertCell();
                    rightNumCell.className = 'diff-line-number';
                    rightNumCell.textContent = rightLineNum;
                    const rightContentCell = rightRow.insertCell();
                    rightContentCell.className = 'diff-line-content';
                    rightContentCell.textContent = op.line;

                    rightLineNum++;
                }
            }
        }

        // Compute diff using Myers' diff algorithm (LCS-based)
        function computeDiff(oldLines, newLines) {
            const lcs = computeLCS(oldLines, newLines);
            const diff = [];

            let i = 0; // index in oldLines
            let j = 0; // index in newLines
            let lcsIndex = 0; // index in lcs

            while (i < oldLines.length || j < newLines.length) {
                if (lcsIndex < lcs.length &&
                    i === lcs[lcsIndex].oldIndex &&
                    j === lcs[lcsIndex].newIndex) {
                    // Common line
                    diff.push({ type: 'equal', line: oldLines[i] });
                    i++;
                    j++;
                    lcsIndex++;
                } else if (lcsIndex < lcs.length && i < lcs[lcsIndex].oldIndex) {
                    // Deleted line
                    diff.push({ type: 'delete', line: oldLines[i] });
                    i++;
                } else if (lcsIndex < lcs.length && j < lcs[lcsIndex].newIndex) {
                    // Added line
                    diff.push({ type: 'insert', line: newLines[j] });
                    j++;
                } else {
                    // At end, handle remaining lines
                    if (i < oldLines.length) {
                        diff.push({ type: 'delete', line: oldLines[i] });
                        i++;
                    } else if (j < newLines.length) {
                        diff.push({ type: 'insert', line: newLines[j] });
                        j++;
                    }
                }
            }

            return diff;
        }

        // Compute Longest Common Subsequence
        function computeLCS(oldLines, newLines) {
            const m = oldLines.length;
            const n = newLines.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

            // Fill DP table
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (oldLines[i - 1] === newLines[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }

            // Backtrack to find LCS
            const lcs = [];
            let i = m, j = n;
            while (i > 0 && j > 0) {
                if (oldLines[i - 1] === newLines[j - 1]) {
                    lcs.unshift({ oldIndex: i - 1, newIndex: j - 1, line: oldLines[i - 1] });
                    i--;
                    j--;
                } else if (dp[i - 1][j] > dp[i][j - 1]) {
                    i--;
                } else {
                    j--;
                }
            }

            return lcs;
        }

        function displayUnifiedDiff(container, unifiedDiff) {
            // Create split view container
            const splitView = document.createElement('div');
            splitView.className = 'diff-split-view';

            // Create left pane (old content)
            const leftPane = document.createElement('div');
            leftPane.className = 'diff-split-pane';
            leftPane.innerHTML = '<div class="diff-split-header">Original</div>';
            const leftTable = document.createElement('table');
            leftTable.className = 'diff-table split';
            leftPane.appendChild(leftTable);

            // Create right pane (new content)
            const rightPane = document.createElement('div');
            rightPane.className = 'diff-split-pane';
            rightPane.innerHTML = '<div class="diff-split-header">Changed</div>';
            const rightTable = document.createElement('table');
            rightTable.className = 'diff-table split';
            rightPane.appendChild(rightTable);

            splitView.appendChild(leftPane);
            splitView.appendChild(rightPane);
            container.appendChild(splitView);

            const lines = unifiedDiff.split('\n');
            let leftLineNum = 1;
            let rightLineNum = 1;

            for (const line of lines) {
                if (line.startsWith('@@')) {
                    // Hunk header - extract starting line numbers
                    const match = line.match(/@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@/);
                    if (match) {
                        leftLineNum = parseInt(match[1]);
                        rightLineNum = parseInt(match[2]);
                    }
                    continue;
                }

                if (line.startsWith('-')) {
                    // Removed line - show in left pane only
                    const leftRow = leftTable.insertRow();
                    leftRow.className = 'diff-line removed';

                    const lineNumCell = leftRow.insertCell();
                    lineNumCell.className = 'diff-line-number';
                    lineNumCell.textContent = leftLineNum;

                    const contentCell = leftRow.insertCell();
                    contentCell.className = 'diff-line-content';
                    contentCell.textContent = line.substring(1);

                    leftLineNum++;
                } else if (line.startsWith('+')) {
                    // Added line - show in right pane only
                    const rightRow = rightTable.insertRow();
                    rightRow.className = 'diff-line added';

                    const lineNumCell = rightRow.insertCell();
                    lineNumCell.className = 'diff-line-number';
                    lineNumCell.textContent = rightLineNum;

                    const contentCell = rightRow.insertCell();
                    contentCell.className = 'diff-line-content';
                    contentCell.textContent = line.substring(1);

                    rightLineNum++;
                } else {
                    // Context line (unchanged) - show in both panes
                    const leftRow = leftTable.insertRow();
                    leftRow.className = 'diff-line context';
                    const leftNumCell = leftRow.insertCell();
                    leftNumCell.className = 'diff-line-number';
                    leftNumCell.textContent = leftLineNum;
                    const leftContentCell = leftRow.insertCell();
                    leftContentCell.className = 'diff-line-content';
                    leftContentCell.textContent = line.startsWith(' ') ? line.substring(1) : line;

                    const rightRow = rightTable.insertRow();
                    rightRow.className = 'diff-line context';
                    const rightNumCell = rightRow.insertCell();
                    rightNumCell.className = 'diff-line-number';
                    rightNumCell.textContent = rightLineNum;
                    const rightContentCell = rightRow.insertCell();
                    rightContentCell.className = 'diff-line-content';
                    rightContentCell.textContent = line.startsWith(' ') ? line.substring(1) : line;

                    leftLineNum++;
                    rightLineNum++;
                }
            }
        }

        function displaySimpleDiff(container, file) {
            const table = document.createElement('table');
            table.className = 'diff-table';
            container.appendChild(table);

            if (file.changeType === 'add') {
                // New file - show all lines as added
                const lines = file.content ? file.content.split('\n') : [];
                lines.forEach((line, i) => {
                    const row = table.insertRow();
                    row.className = 'diff-line added';

                    const lineNumCell = row.insertCell();
                    lineNumCell.className = 'diff-line-number';
                    lineNumCell.textContent = i + 1;

                    const contentCell = row.insertCell();
                    contentCell.className = 'diff-line-content';
                    contentCell.textContent = line;
                });
            } else if (file.changeType === 'delete') {
                // Deleted file - show all lines as removed
                const lines = file.previousContent ? file.previousContent.split('\n') : [];
                lines.forEach((line, i) => {
                    const row = table.insertRow();
                    row.className = 'diff-line removed';

                    const lineNumCell = row.insertCell();
                    lineNumCell.className = 'diff-line-number';
                    lineNumCell.textContent = i + 1;

                    const contentCell = row.insertCell();
                    contentCell.className = 'diff-line-content';
                    contentCell.textContent = line;
                });
            } else {
                // Modified file without unified diff - show message
                const row = table.insertRow();
                row.className = 'diff-line context';
                const cell = row.insertCell();
                cell.colSpan = 2;
                cell.className = 'diff-line-content';
                cell.textContent = 'Diff not available for this file';
            }
        }

        function createCommentHtml(comment) {
            const severityClass = `severity-${comment.severity}`;
            const isPosted = comment.posted;

            return `
                <div class="comment-item" id="comment-${comment.id}">
                    <div class="comment-meta">
                        <span class="badge ${severityClass}">${comment.severity}</span>
                        <span class="badge type">${comment.commentType}</span>
                        <span class="line-number">Line ${comment.lineNumber}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.commentText)}</div>
                    <div class="comment-actions">
                        ${isPosted ?
                            '<button class="btn-posted" disabled>âœ“ Posted</button>' :
                            `<button class="btn-post" onclick="postComment('${comment.id}')">Post to PR</button>`
                        }
                    </div>
                </div>
            `;
        }

        async function postComment(commentId) {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Posting...';

            try {
                const response = await fetch('/api/CodeReview/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commentId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to post comment');
                }

                const result = await response.json();

                // Update UI
                const commentItem = document.getElementById(`comment-${commentId}`);
                const actionsDiv = commentItem.querySelector('.comment-actions');
                actionsDiv.innerHTML = '<button class="btn-posted" disabled>âœ“ Posted</button>';

                // Update current review
                const comment = currentReview.comments.find(c => c.id === commentId);
                if (comment) comment.posted = true;

                showSuccess('Comment posted successfully to the PR!');
            } catch (error) {
                showError(error.message);
                button.disabled = false;
                button.textContent = 'Post to PR';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => hideError(), 5000);
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => hideSuccess(), 5000);
        }

        function hideSuccess() {
            document.getElementById('success').style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
